"use strict";function s4(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}function guid(){return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}angular.module("firePokerApp",["firebase","ngCookies","contenteditable"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/games/index.html",controller:"MainCtrl"}).when("/games/new/:gid",{templateUrl:"views/games/new.html",controller:"MainCtrl"}).when("/games/:gid",{templateUrl:"views/games/view.html",controller:"MainCtrl"}).when("/games/join/:gid",{templateUrl:"views/games/join.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("firePokerApp").controller("MainCtrl",["$rootScope","$scope","$cookieStore","$location","$routeParams","angularFire",function(a,b,c,d,e,f){var g="https://pzfqrq7kjy.firebaseio.com";if(b.fp=c.get("fp"),b.fp||(b.fp={}),!b.fp.user||!b.fp.user.id){var h=guid();b.fp.user={id:h},c.put("fp",b.fp)}if(!b.fp.gid){var i=guid();b.fp.gid=i,c.put("fp",b.fp)}a.showNavbar="/"!==d.path();var j=new Firebase(g);if("/games/new"===d.path()||"/games/new/"===d.path()){var k=guid();d.path("/games/new/"+k).replace()}if(e.gid&&d.path()==="/games/"+e.gid&&!b.fp.user.fullname&&d.path("/games/join/"+e.gid).replace(),e.gid&&d.path()==="/games/join/"+e.gid&&b.fp.user.fullname&&d.path("/games/"+e.gid).replace(),e.gid&&d.path()==="/games/"+e.gid){f(j.child("/games/"+e.gid),b,"game").then(function(){b.isOwner=b.game.owner&&b.game.owner.id&&b.game.owner.id===b.fp.user.id?!0:!1}),j.child("/games/"+e.gid+"/participants/"+b.fp.user.id).set(b.fp.user);var l=j.child("/games/"+e.gid+"/participants/"+b.fp.user.id+"/online"),m=j.child("/.info/connected");m.on("value",function(a){a.val()===!0&&(l.onDisconnect().set(Firebase.ServerValue.TIMESTAMP),l.set(!0))})}b.createGame=function(){var a=[],f=angular.copy(b.newGame);f.stories&&angular.forEach(f.stories.split("\n"),function(b){var c={title:b,status:"queue"};a.push(c)}),f.stories=a,f.status="active",f.created=(new Date).getTime(),f.owner=b.fp.user,f.participants=!1,f.estimate=!1,j.child("/games/"+e.gid).set(f),c.put("fp",b.fp),d.path("/games/"+e.gid).replace()},b.createStory=function(a){if("structured"===a){var c="As a/an "+b.newStory.asA+" I would like to "+b.newStory.iWouldLikeTo+" so that "+b.newStory.soThat;b.newStory.title=c,delete b.newStory.asA,delete b.newStory.iWouldLikeTo,delete b.newStory.soThat}b.newStory.results=!1,b.newStory.points=0,b.newStory.status="queue",b.newStory.startedAt=!1,b.newStory.endedAt=!1,b.game.stories||(b.game.stories=[]),b.game.stories.push(b.newStory),b.newStory=null,b.game.estimate||b.setStory(b.game.stories.length-1)},b.setStory=function(a){b.resetRound(),b.game.estimate=b.game.stories[a],b.game.estimate.status="active",b.game.estimate.id=a,b.game.estimate.startedAt=(new Date).getTime(),b.game.estimate.endedAt=!1},b.deleteStory=function(a){b.game.stories.splice(a,1)},b.estimate=function(a){b.game.estimate.results||(b.game.estimate.results=[]),b.game.estimate.results.push({points:a,user:b.fp.user})},b.setFullname=function(){c.put("fp",b.fp),d.path("/games/"+e.gid).replace()},b.getResultsAverage=function(){var a=0;if(b.game.estimate.results){var c=0;angular.forEach(b.game.estimate.results,function(a){a.points&&angular.isNumber(a.points)&&(c+=+a.points)}),a=Math.ceil(c/b.game.estimate.results.length)}return a},b.totalOfOnlineParticipants=function(){var a=0;return b.game&&b.game.participants&&angular.forEach(b.game.participants,function(b){b.online===!0&&a++}),a},b.acceptRound=function(){b.game.estimate.points=b.newEstimate.points,b.game.estimate.endedAt=(new Date).getTime(),b.game.estimate.status="closed",b.game.stories[b.game.estimate.id]=angular.copy(b.game.estimate),b.game.estimate=!1},b.playAgain=function(){b.game.estimate.results=[],b.game.estimate.status="active"},b.resetRound=function(){if(b.game.estimate){var a=b.game.estimate.id;b.game.stories[a].startedAt=!1,b.game.stories[a].endedAt=!1,b.game.stories[a].status="queue",b.game.estimate=!1}},b.revealCards=function(){b.game.estimate.status="reveal"},b.decks=[[0,1,2,4,8,16,32,64,128,"?"],[0,.5,1,2,3,5,8,13,20,40,100,"?"]],b.newGame={deck:0},b.$watch("game",function(a){b.showCardDeck=!0,b.showSelectEstimate=!1,b.showAddStory=!1,b.disablePlayAgainAndRevealButtons=!1,b.showCards=!1,a&&(a.estimate&&a.estimate.results&&angular.forEach(a.estimate.results,function(a){a&&a.user&&a.user.id&&a.user.id===b.fp.user.id&&(b.showCardDeck=!1)}),a.estimate&&a.owner&&a.owner.id===b.fp.user.id&&(b.showSelectEstimate=!0),b.newEstimate={points:b.getResultsAverage()},a.owner&&a.owner.id===b.fp.user.id&&(b.showAddStory=!0),a.estimate.results&&0!==a.estimate.results.length||(b.disablePlayAgainAndRevealButtons=!0),"reveal"==b.game.estimate.status?b.showCards=!0:a.estimate&&a.estimate.results&&a.estimate.results.length&&a.estimate.results.length>=b.totalOfOnlineParticipants()&&(b.showCards=!0))})}]);